name: FastAPI CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # JOB 1: LINT & TEST
  linting-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linting and tests
        env:
          PYTHONPATH: .
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          SECRET_KEY: test_secret_key
        run: |
          flake8 . --count --exit-zero --max-complexity=10 --statistics
          pytest

  # JOB 2: BUILD & PUSH (D√πng github.sha)
  build-and-push:
    needs: linting-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          # L·∫•y gi√° tr·ªã th√¥ t·ª´ secret
          RAW_ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_URI }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # 1. X·ª¨ L√ù BI·∫æN (L√†m s·∫°ch chu·ªói URI)
          CLEAN_REPO_URI=$(echo "$RAW_ECR_REPOSITORY" | sed 's|https://||g')
          # Chuy·ªÉn t·∫•t c·∫£ th√†nh ch·ªØ th∆∞·ªùng (Lowercase)
          CLEAN_REPO_URI=$(echo "$CLEAN_REPO_URI" | tr '[:upper:]' '[:lower:]')

          echo "Original URI: $RAW_ECR_REPOSITORY"
          echo "Cleaned URI: $CLEAN_REPO_URI"

          # 2. BUILD
          docker build -t $CLEAN_REPO_URI:$IMAGE_TAG .

          # 3. PUSH
          docker push $CLEAN_REPO_URI:$IMAGE_TAG

  # JOB 3: DEPLOY (Pull ƒë√∫ng github.sha)
  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_URI: ${{ secrets.ECR_REPOSITORY_URI }}
          # Truy·ªÅn SHA v√†o bi·∫øn m√¥i tr∆∞·ªùng
          IMAGE_TAG: ${{ github.sha }}

          # C√°c bi·∫øn m√¥i tr∆∞·ªùng kh√°c cho App
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # Th√™m IMAGE_TAG v√†o danh s√°ch envs ƒë·ªÉ truy·ªÅn sang server
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,ECR_URI,IMAGE_TAG,POSTGRES_HOST,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,SECRET_KEY
          script: |
            # 1. C·∫•u h√¨nh AWS tr√™n Server
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
            export AWS_DEFAULT_REGION=$AWS_REGION

            # 2. X√°c ƒë·ªãnh Image c·∫ßn pull (D√πng bi·∫øn IMAGE_TAG truy·ªÅn t·ª´ Github)
            FULL_IMAGE="$ECR_URI:$IMAGE_TAG"

            echo "========================================"
            echo "üöÄ DEPLOYING VERSION: $IMAGE_TAG"
            echo "Target Image: $FULL_IMAGE"
            echo "========================================"

            # 3. Login ECR
            REGISTRY_DOMAIN=$(echo "$ECR_URI" | cut -d'/' -f1)
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY_DOMAIN

            # 4. Pull Image (ƒê√∫ng phi√™n b·∫£n SHA)
            docker pull $FULL_IMAGE

            # 5. Stop container c≈©
            docker stop backend || true
            docker rm backend || true

            # 6. Ch·∫°y container m·ªõi
            docker run -d \
              --name backend \
              --restart always \
              -p 80:8000 \
              -e POSTGRES_HOST="$POSTGRES_HOST" \
              -e POSTGRES_PORT="5432" \
              -e POSTGRES_DB="$POSTGRES_DB" \
              -e POSTGRES_USER="$POSTGRES_USER" \
              -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
              -e SECRET_KEY="$SECRET_KEY" \
              $FULL_IMAGE

            # 7. D·ªçn d·∫πp (X√≥a c√°c image c≈© ƒë·ªÉ ti·∫øt ki·ªám ·ªï c·ª©ng, gi·ªØ l·∫°i image ƒëang ch·∫°y)
            docker image prune -f

            echo "‚úÖ DEPLOY SUCCESSFUL!"

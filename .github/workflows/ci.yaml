name: FastAPI CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # JOB 1: LINT & TEST
  linting-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linting and tests
        env:
          PYTHONPATH: .
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          SECRET_KEY: test_secret_key
        run: |
          flake8 . --count --exit-zero --max-complexity=10 --statistics
          pytest

  # JOB 2: BUILD & PUSH (DÃ¹ng github.sha)
  build-and-push:
    needs: linting-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_URI }}
          IMAGE_TAG: ${{ github.sha }} # <--- DÃ¹ng SHA lÃ m tag
        run: |
          # Build vá»›i tag lÃ  SHA
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

          # Push image cÃ³ tag SHA lÃªn ECR
          docker push $ECR_REPOSITORY:$IMAGE_TAG

  # JOB 3: DEPLOY (Pull Ä‘Ãºng github.sha)
  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_URI: ${{ secrets.ECR_REPOSITORY_URI }}
          # Truyá»n SHA vÃ o biáº¿n mÃ´i trÆ°á»ng
          IMAGE_TAG: ${{ github.sha }}

          # CÃ¡c biáº¿n mÃ´i trÆ°á»ng khÃ¡c cho App
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # ThÃªm IMAGE_TAG vÃ o danh sÃ¡ch envs Ä‘á»ƒ truyá»n sang server
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,ECR_URI,IMAGE_TAG,POSTGRES_HOST,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,SECRET_KEY
          script: |
            # 1. Cáº¥u hÃ¬nh AWS trÃªn Server
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
            export AWS_DEFAULT_REGION=$AWS_REGION

            # 2. XÃ¡c Ä‘á»‹nh Image cáº§n pull (DÃ¹ng biáº¿n IMAGE_TAG truyá»n tá»« Github)
            FULL_IMAGE="$ECR_URI:$IMAGE_TAG"

            echo "========================================"
            echo "ðŸš€ DEPLOYING VERSION: $IMAGE_TAG"
            echo "Target Image: $FULL_IMAGE"
            echo "========================================"

            # 3. Login ECR
            REGISTRY_DOMAIN=$(echo "$ECR_URI" | cut -d'/' -f1)
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY_DOMAIN

            # 4. Pull Image (ÄÃºng phiÃªn báº£n SHA)
            docker pull $FULL_IMAGE

            # 5. Stop container cÅ©
            docker stop backend || true
            docker rm backend || true

            # 6. Cháº¡y container má»›i
            docker run -d \
              --name backend \
              --restart always \
              -p 80:8000 \
              -e POSTGRES_HOST="$POSTGRES_HOST" \
              -e POSTGRES_PORT="5432" \
              -e POSTGRES_DB="$POSTGRES_DB" \
              -e POSTGRES_USER="$POSTGRES_USER" \
              -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
              -e SECRET_KEY="$SECRET_KEY" \
              $FULL_IMAGE

            # 7. Dá»n dáº¹p (XÃ³a cÃ¡c image cÅ© Ä‘á»ƒ tiáº¿t kiá»‡m á»• cá»©ng, giá»¯ láº¡i image Ä‘ang cháº¡y)
            docker image prune -f

            echo "âœ… DEPLOY SUCCESSFUL!"
